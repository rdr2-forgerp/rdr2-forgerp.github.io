<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 — Повозки</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin:0; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* фон як у карти */
    #map{
      height:100vh;
      width:100vw;
      background: #cdb38f;
    }

    /* віньєтка */
    #map::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,.16) 75%,
        rgba(0,0,0,.30) 100%);
      mix-blend-mode: multiply;
    }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }

    /* Marker */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: #f3e6cf;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{ width: 26px; height: 26px; display:block; }

    /* Card */
    .rdrCard {
      width: 540px;
      border-radius: 26px;
      overflow: hidden;
      background: rgba(45, 30, 18, 0.92);
      color: #f3e6cf;
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }

    .rdrTop { position: relative; height: 290px; background: #1a110a; }
    .rdrImg { width: 100%; height: 100%; object-fit: cover; display:block; filter: saturate(.95) contrast(1.05); }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 16px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      color: #ffe6b2;
      white-space: nowrap;
    }

    /* stats */
    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat .label{
      font-size: 12px;
      opacity: .88;
      margin-bottom: 6px;
    }
    .stat .value{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* price */
    .priceRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .priceLabel{
      font-size: 12px;
      opacity: .85;
      font-weight: 800;
    }
    .priceValue{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .4px;
      color: #ffe6b2;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    @media (max-width: 620px){
      .rdrCard { width: 92vw; }
      .rdrTop { height: 220px; }
      .statsGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  // =========================
  // PATH FIX (GitHub Pages)
  // =========================
  const basePath = location.pathname.endsWith("/")
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, "");

  const MAP_URL   = basePath + "map.jpg";
  const WAGON_URL = basePath + "wagon.png";

  // cache-bust (щоб GitHub кеш не заважав після пуша)
  const bust = `?v=${Date.now()}`;

  // =========================
  // STORAGE
  // =========================
  const STORAGE_KEY = "rdr2_wagons_v2";
  function loadState() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
    catch(e){ return null; }
  }
  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // ==========================================================
  // ✅ ТУТ ТИ МІНЯЄШ ДАНІ ПОВОЗОК (W1..W15)
  // ==========================================================
  // photos:
  // - локально: basePath + "W1.jpg"
  // - або URL: "https://....jpg"
  //
  // x,y (позиції) ми потім підставимо твої (або ти напишеш координати)
  const WAGONS_DATA = [
    {
      id: 1,
      name: "W1",
      price: 3100,
      deliveriesToBuy: 20,
      passengers: 2,
      slots: 0,
      kg: 0,
      photos: [basePath + "W1.jpg"],

      // тимчасово (потім замінимо на твої)
      x: null,
      y: null
    },

    // W2..W15 поки пусті — просто заповнюй так само
    { id: 2,  name: "W2",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 3,  name: "W3",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 4,  name: "W4",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 5,  name: "W5",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 6,  name: "W6",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 7,  name: "W7",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 8,  name: "W8",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 9,  name: "W9",  price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 10, name: "W10", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 11, name: "W11", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 12, name: "W12", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 13, name: "W13", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 14, name: "W14", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
    { id: 15, name: "W15", price: 0, deliveriesToBuy: 0, passengers: 0, slots: 0, kg: 0, photos: [], x: null, y: null },
  ];

  // =========================
  // helpers
  // =========================
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
  function num(n){ const x = Number(n||0); return Number.isFinite(x) ? x : 0; }
  function fmtInt(n){ return Math.round(num(n)).toString(); }
  function fmtPrice(n){ return num(n).toLocaleString('uk-UA'); }

  function renderDots(count, activeIndex) {
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++){
      html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    }
    html += `</div>`;
    return html;
  }

  function cardHtml(w, photoIndex){
    const photos = (w.photos && w.photos.length) ? w.photos : [WAGON_URL];
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));

    return `
      <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${photos[idx]}" alt="photo">
          <button class="rdrClose" data-action="close">×</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev">‹</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next">›</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${escapeHtml(w.name)}</div>
            <div class="idPill">#${w.id}</div>
          </div>

          <div class="statsGrid">
            <div class="stat">
              <div class="label">Пасажирів</div>
              <div class="value">${fmtInt(w.passengers)}</div>
            </div>
            <div class="stat">
              <div class="label">Слоти</div>
              <div class="value">${fmtInt(w.slots)}</div>
            </div>
            <div class="stat">
              <div class="label">Кг</div>
              <div class="value">${fmtInt(w.kg)}</div>
            </div>
            <div class="stat">
              <div class="label">Потрібно доставок для купівлі</div>
              <div class="value">${fmtInt(w.deliveriesToBuy)}</div>
            </div>
          </div>

          <div class="priceRow">
            <div class="priceLabel">Ціна</div>
            <div class="priceValue">${fmtPrice(w.price)}</div>
          </div>
        </div>
      </div>
    `;
  }

  function markerHtml(id){
    return `
      <div class="pinWrap">
        <div class="pinBadge">#${id}</div>
        <div class="pinIcon"><img src="${WAGON_URL}" alt=""></div>
      </div>
    `;
  }

  // =========================
  // preload map.jpg to get size
  // =========================
  const preload = new Image();
  preload.onload = () => initMap(preload.width, preload.height);
  preload.onerror = () => {
    alert(
      "Не можу завантажити карту.\n\n" +
      "Перевір:\n" +
      "1) файл називається ТОЧНО map.jpg (регістр важливий)\n" +
      "2) лежить поруч з index.html\n\n" +
      "Спроба завантажити: " + MAP_URL
    );
  };
  preload.src = MAP_URL + bust;

  // =========================
  // init map
  // =========================
  function initMap(MAP_WIDTH, MAP_HEIGHT){
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: true
    });

    const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
    L.imageOverlay(MAP_URL + bust, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // беремо з localStorage (позиції після drag), або з WAGONS_DATA
    const saved = loadState();

    // зробимо копію даних + поставимо дефолтні координати якщо null
    const wagons = (saved?.wagons ?? WAGONS_DATA.map(w => ({...w}))).map((w, idx) => {
      const ww = {...w};

      // Якщо координати ще не задані — ставимо тимчасові "кучкою"
      if (ww.x == null || ww.y == null){
        ww.x = Math.round(MAP_WIDTH * (0.55 + (idx%5)*0.04));
        ww.y = Math.round(MAP_HEIGHT * (0.25 + Math.floor(idx/5)*0.06));
      }
      return ww;
    });

    const markers = new Map();
    const wagonById = (id) => wagons.find(x => x.id === id);

    function openWagonPopup(w, photoIndex = 0){
      const marker = markers.get(w.id);
      if (!marker) return;

      L.popup({ closeButton: false, maxWidth: 560 })
        .setLatLng([w.y, w.x])
        .setContent(cardHtml(w, photoIndex))
        .openOn(map);

      setTimeout(() => bindCard(w.id), 0);
    }

    function bindCard(id){
      const card = document.querySelector(`.rdrCard[data-id="${id}"]`);
      if (!card) return;
      const w = wagonById(id);
      if (!w) return;

      const photos = (w.photos && w.photos.length) ? w.photos : [WAGON_URL];
      const getIdx = () => parseInt(card.getAttribute("data-idx"), 10) || 0;

      const closeBtn = card.querySelector('[data-action="close"]');
      if (closeBtn) closeBtn.onclick = () => map.closePopup();

      const prevBtn = card.querySelector('[data-action="prev"]');
      const nextBtn = card.querySelector('[data-action="next"]');

      if (prevBtn) prevBtn.onclick = () => openWagonPopup(w, (getIdx() - 1 + photos.length) % photos.length);
      if (nextBtn) nextBtn.onclick = () => openWagonPopup(w, (getIdx() + 1) % photos.length);
    }

    // markers
    wagons.forEach(w => {
      const icon = L.divIcon({
        className: "",
        html: markerHtml(w.id),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      const m = L.marker([w.y, w.x], { icon, draggable: true }).addTo(map);
      markers.set(w.id, m);

      m.on('click', () => openWagonPopup(w, 0));

      // drag = зберігає позицію
      m.on('dragend', (e) => {
        const ll = e.target.getLatLng();
        w.y = ll.lat;
        w.x = ll.lng;
        saveState({ wagons });
      });
    });

    // click coords (для розстановки)
    map.on('click', (e) => {
      alert(`Координати:\nY(lat): ${Math.round(e.latlng.lat)}\nX(lng): ${Math.round(e.latlng.lng)}`);
    });
  }
</script>
</body>
</html>
