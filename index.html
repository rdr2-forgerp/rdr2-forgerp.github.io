<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 ‚Äî –ü–æ–≤–æ–∑–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg: #D2B791;
      --ui: rgba(35,24,14,.92);
      --ui2: rgba(45,30,18,.92);
      --text: #f3e6cf;
      --gold: #ffe6b2;
    }

    body{
      margin:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow: hidden;
    }

    /* –≤–∞–∂–ª–∏–≤–æ: –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π —Å—ñ—Ä–∏–π —Ñ–æ–Ω Leaflet */
    .leaflet-container,
    .leaflet-pane,
    .leaflet-map-pane,
    .leaflet-tile-pane,
    .leaflet-overlay-pane{
      background: var(--bg) !important;
    }

    #map{
      position: relative;
      height:100vh;
      width:100vw;
      background: var(--bg);
    }

    /* –≤—ñ–Ω—å—î—Ç–∫–∞ */
    #map::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 250;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,.16) 75%,
        rgba(0,0,0,.30) 100%);
      mix-blend-mode: multiply;
    }

    /* ===== TOP RIGHT CONTROLS (–Ω–µ –∑–∞–≤–∞–∂–∞—î –∑—É–º—É) ===== */
    .topControls{
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .uiBtn{
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 900;
      background: var(--ui);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .uiBtn:hover{ background: rgba(35,24,14,.98); }

    /* ===== COORDS TOAST ===== */
    .coordsToast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(35,24,14,.90);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      font-weight: 900;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display:none;
      pointer-events: none;
    }

    /* ===== SIDEBAR ===== */
    .sidebar{
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 340px;
      max-width: 86vw;
      z-index: 9998;
      background: rgba(20,14,8,.92);
      border-right: 1px solid rgba(255,255,255,.10);
      box-shadow: 20px 0 60px rgba(0,0,0,.35);
      transform: translateX(-110%);
      transition: transform .22s ease;
      display:flex;
      flex-direction: column;
      backdrop-filter: blur(6px);
    }
    .sidebar.open{ transform: translateX(0); }

    .sideHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sideTitle{
      font-weight: 1000;
      color: var(--text);
      letter-spacing: .2px;
      font-size: 16px;
    }
    .sideClose{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 1000;
      cursor: pointer;
    }
    .sideClose:hover{ background: rgba(255,255,255,.14); }

    .sideBody{
      padding: 12px;
      overflow:auto;
      flex: 1;
    }

    .wagonItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      cursor: pointer;
      margin-bottom: 10px;
      user-select: none;
    }
    .wagonItem:hover{ background: rgba(255,255,255,.10); }
    .wagonLeft{
      display:flex; flex-direction: column; gap: 2px;
    }
    .wagonTop{ font-weight: 1000; letter-spacing: .2px; }
    .wagonSub{ font-size: 12px; opacity: .85; font-weight: 800; }
    .wagonPill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--gold);
      font-weight: 1000;
      white-space: nowrap;
    }

    /* Popup shell */
    .leaflet-popup-content-wrapper { background: transparent; box-shadow:none; }
    .leaflet-popup-content { margin: 0; }
    .leaflet-popup-tip { background: rgba(40,28,16,.92); }

    /* Marker */
    .pinWrap{
      position: relative;
      width: 44px; height: 44px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.45));
      user-select: none;
      pointer-events: auto;
    }
    .pinBadge{
      position:absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px 7px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .pinIcon{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(35,24,14,.92);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pinIcon img{ width: 26px; height: 26px; display:block; }

    /* Card */
    .rdrCard{
      width: 540px;
      border-radius: 26px;
      overflow: hidden;
      background: var(--ui2);
      color: var(--text);
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      position: relative;
      backdrop-filter: blur(2px);
    }

    .rdrTop{ position: relative; height: 290px; background: #1a110a; }
    .rdrImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      filter: saturate(.95) contrast(1.05);
      background: rgba(0,0,0,.15);
    }

    .rdrClose{
      position:absolute; top: 12px; right: 12px;
      width: 34px; height: 34px;
      border: 0; border-radius: 10px;
      cursor: pointer;
      color: #fff;
      background: rgba(0,0,0,.35);
      font-size: 20px; line-height: 34px;
      z-index: 5;
    }
    .rdrClose:hover { background: rgba(0,0,0,.55); }

    .navBtn{
      position:absolute; top:50%;
      transform: translateY(-50%);
      width: 48px; height: 48px;
      border: 0; border-radius: 999px;
      cursor: pointer;
      color:#fff;
      background: rgba(0,0,0,.35);
      font-size: 24px; line-height: 48px;
      z-index: 5;
    }
    .navBtn:hover{ background: rgba(0,0,0,.55); }
    .navLeft{ left: 14px; }
    .navRight{ right: 14px; }

    .dotsWrap{
      position:absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display:flex; gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      z-index: 5;
    }
    .dot{ width: 8px; height: 8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.active{ background: rgba(255,255,255,.9); }

    .rdrBody{
      padding: 14px 16px 16px;
      background: linear-gradient(to bottom, rgba(45,30,18,.92), rgba(30,20,12,.92));
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleRow .name{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .titleRow .idPill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 1000;
      color: var(--gold);
      white-space: nowrap;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat .label{ font-size: 12px; opacity: .88; margin-bottom: 6px; font-weight: 900; }
    .stat .value{ font-size: 18px; font-weight: 1000; letter-spacing: .2px; }

    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:flex-start;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .priceLabel{
      font-size: 14px;
      opacity: .90;
      font-weight: 1000;
      color: var(--text);
    }
    .priceValue{
      font-size: 28px;
      font-weight: 1100;
      letter-spacing: .4px;
      color: var(--gold);
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    /* group picker */
    .pickRow{
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pickTitle{
      font-size: 12px;
      opacity: .85;
      font-weight: 1000;
      margin-bottom: 8px;
    }
    .pickBtns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pickBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }
    .pickBtn.active{
      background: rgba(255,255,255,.18);
      color: var(--gold);
    }

    @media (max-width: 620px){
      .rdrCard { width: 92vw; }
      .rdrTop { height: 220px; }
      .statsGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sideHeader">
      <div class="sideTitle">–°–ø–∏—Å–æ–∫ –ø–æ–≤–æ–∑–æ–∫</div>
      <button class="sideClose" id="sideClose" type="button">√ó</button>
    </div>
    <div class="sideBody" id="sideList"></div>
  </aside>

  <!-- top right buttons -->
  <div class="topControls">
    <button class="uiBtn" id="listBtn" type="button">‚ò∞ –°–ø–∏—Å–æ–∫</button>
    <button class="uiBtn" id="coordsBtn" type="button">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: –í–∏–º–∫</button>
    <button class="uiBtn" id="reloadBtn" type="button">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</button>
  </div>

  <div class="coordsToast" id="coordsToast"></div>
  <div id="map"></div>

<script>
  // ===== PATH (GitHub Pages) =====
  const basePath = location.pathname.endsWith("/")
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, "");

  const bust = `?v=${Date.now()}`;
  const MAP_URL   = basePath + "map.jpg" + bust;
  const WAGON_URL = basePath + "wagon.png" + bust;

  // ===== DATA =====
  const WAGONS_DATA = [
    { id: 1,  title: "–í–æ–∑–∏–∫", code: "W1",  price: 3100, deliveriesToBuy: 20, passengers: 2, slots: 0, kg: 0, photos: ["W1.jpg"],  x: 1874, y: 747 },
    { id: 2,  title: "–í–æ–∑–∏–∫", code: "W2",  price: 6000, deliveriesToBuy: 80, passengers: 8, slots: 30, kg: 50, photos: ["W2.jpg"],  x: 1969, y: 1182 },
    { id: 3,  title: "–í–æ–∑–∏–∫", code: "W3",  price: 3850, deliveriesToBuy: 30, passengers: 3, slots: 40, kg: 100, photos: ["W3.jpg"], x: 1621, y: 989 },

    { id: 4,  title: "–í–æ–∑–∏–∫", code: "W4",  price: 3050, deliveriesToBuy: 20, passengers: 2, slots: 0, kg: 0, photos: ["W4.jpg"], x: null, y: null },
    { id: 5,  title: "–í–æ–∑–∏–∫", code: "W5",  price: 3350, deliveriesToBuy: 20, passengers: 2, slots: 40, kg: 175, photos: ["W5.jpg"], x: null, y: null },
    { id: 6,  title: "–í–æ–∑–∏–∫", code: "W6",  price: 3250, deliveriesToBuy: 20, passengers: 2, slots: 30, kg: 125, photos: ["W6.jpg"], x: null, y: null },
    { id: 7,  title: "–í–æ–∑–∏–∫", code: "W7",  price: 2800, deliveriesToBuy: 15, passengers: 1, slots: 30, kg: 100, photos: ["W7.jpg"], x: null, y: null },

    { id: 8,  title: "–í–æ–∑–∏–∫", code: "W8",  price: 2750, deliveriesToBuy: 10, passengers: 1, slots: 30, kg: 50, photos: ["W8.jpg"], x: null, y: null },
    { id: 9,  title: "–í–æ–∑–∏–∫", code: "W9",  price: 3000, deliveriesToBuy: 20, passengers: 2, slots: 0, kg: 0, photos: ["W9.jpg"], x: null, y: null },

    { id: 10, title: "–í–æ–∑–∏–∫", code: "W10", price: 5250, deliveriesToBuy: 60, passengers: 6, slots: 30, kg: 100, photos: ["W10.jpg"], x: null, y: null },
    { id: 11, title: "–í–æ–∑–∏–∫", code: "W11", price: 8000, deliveriesToBuy: 120, passengers: 12, slots: 30, kg: 50, photos: ["W11.jpg"], x: null, y: null },
    { id: 12, title: "–í–æ–∑–∏–∫", code: "W12", price: 7250, deliveriesToBuy: 100, passengers: 10, slots: 30, kg: 50, photos: ["W12.jpg"], x: null, y: null },

    { id: 13, title: "–í–æ–∑–∏–∫", code: "W13", price: 2500, deliveriesToBuy: 5, passengers: 1, slots: 30, kg: 50, photos: ["W13.jpg"], x: 1222, y: 763 },

    { id: 14, title: "–í–æ–∑–∏–∫", code: "W14", price: 6500, deliveriesToBuy: 80, passengers: 6, slots: 50, kg: 350, photos: ["W14.jpg"], x: null, y: null },
    { id: 15, title: "–í–æ–∑–∏–∫", code: "W15", price: 8250, deliveriesToBuy: 120, passengers: 12, slots: 30, kg: 150, photos: ["W15.jpg"], x: null, y: null },
  ];

  // ===== GROUPS (—Ç—É—Ç —Ç–∏ –ø–∏—à–µ—à –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞ –≥—Ä—É–ø–∏) =====
  const GROUPS = [
    { ids: [1], x: 1874, y: 747 },
    { ids: [2], x: 1969, y: 1182 },
    { ids: [3], x: 1621, y: 989 },

    { ids: [4,5,6,7], x: 1315, y: 1181 },
    { ids: [8,9], x: 1129, y: 1491 },
    { ids: [10,11,12], x: 1046, y: 922 },

    { ids: [13], x: 1222, y: 763 },
    { ids: [14,15], x: 318, y: 443 },
  ];

  // ===== HELPERS =====
  const num = (n) => (Number.isFinite(Number(n)) ? Number(n) : 0);
  const fmtInt = (n) => String(Math.round(num(n)));

  function fmtPriceDot(n){
    const s = Math.round(num(n)).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");

  function resolveUrl(u){
    const s = String(u || "").trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("data:")) return s;
    return basePath + s + bust;
  }

  function renderDots(count, activeIndex){
    let html = `<div class="dotsWrap">`;
    for (let i=0;i<count;i++) html += `<div class="dot ${i===activeIndex ? "active":""}"></div>`;
    html += `</div>`;
    return html;
  }

  function groupLabel(ids){
    if (ids.length === 1) return `#${ids[0]}`;
    const min = Math.min(...ids), max = Math.max(...ids);
    return `#${min}-${max}`;
  }

  function markerHtml(label){
    return `
      <div class="pinWrap">
        <div class="pinBadge">${label}</div>
        <div class="pinIcon"><img src="${WAGON_URL}" alt=""></div>
      </div>
    `;
  }

  // ===== GROUP PICKER UI =====
  function groupHeaderHtml(ids, activeId){
    if (!ids || ids.length <= 1) return "";
    const buttons = ids.map(id => {
      const active = id === activeId ? "active" : "";
      return `<button class="pickBtn ${active}" data-pick="${id}" type="button">#${id}</button>`;
    }).join("");

    return `
      <div class="pickRow">
        <div class="pickTitle">–í–∏–±–µ—Ä–∏ –ø–æ–≤–æ–∑–∫—É:</div>
        <div class="pickBtns">${buttons}</div>
      </div>
    `;
  }

  // ===== CARD =====
  function cardHtml(w, photoIndex){
    const rawPhotos = (w.photos && w.photos.length) ? w.photos : ["wagon.png"];
    const photos = rawPhotos.map(resolveUrl).filter(Boolean);
    const idx = Math.max(0, Math.min(photoIndex ?? 0, photos.length-1));
    const src = photos[idx] || WAGON_URL;

    return `
      <div class="rdrCard" data-id="${w.id}" data-idx="${idx}">
        <div class="rdrTop">
          <img class="rdrImg" src="${src}" alt="photo">
          <button class="rdrClose" data-action="close" type="button">√ó</button>

          ${photos.length>1 ? `<button class="navBtn navLeft" data-action="prev" type="button">‚Äπ</button>` : ``}
          ${photos.length>1 ? `<button class="navBtn navRight" data-action="next" type="button">‚Ä∫</button>` : ``}
          ${photos.length>1 ? renderDots(photos.length, idx) : ``}
        </div>

        <div class="rdrBody">
          <div class="titleRow">
            <div class="name">${esc(w.title || "–í–æ–∑–∏–∫")}</div>
            <div class="idPill">#${w.id}</div>
          </div>

          <div class="statsGrid">
            <div class="stat"><div class="label">–ü–∞—Å–∞–∂–∏—Ä—ñ–≤</div><div class="value">${fmtInt(w.passengers)}</div></div>
            <div class="stat"><div class="label">–°–ª–æ—Ç–∏</div><div class="value">${fmtInt(w.slots)}</div></div>
            <div class="stat"><div class="label">–ö–≥</div><div class="value">${fmtInt(w.kg)}</div></div>
            <div class="stat"><div class="label">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è –∫—É–ø—ñ–≤–ª—ñ</div><div class="value">${fmtInt(w.deliveriesToBuy)}</div></div>
          </div>

          <div class="priceRow">
            <span class="priceLabel">–¶—ñ–Ω–∞</span>
            <span class="priceValue">${fmtPriceDot(w.price)} $</span>
          </div>
        </div>
      </div>
    `;
  }

  function groupCardHtml(wagons, groupIds, activeId){
    const w = wagons.find(x => x.id === activeId);
    if (!w) return "";
    const raw = cardHtml(w, 0);
    return raw.replace(`<div class="rdrBody">`, `<div class="rdrBody">${groupHeaderHtml(groupIds, activeId)}`);
  }

  // ===== popup bind (—â–æ–± –∫–Ω–æ–ø–∫–∏ –≤ –ø–æ–ø–∞–ø—ñ –Ω–∞—Ç–∏—Å–∫–∞–ª–∏—Å—å) =====
  function bindGroupPopup(wagons, groupIds, activeId, marker){
    const root = document.querySelector(`.rdrCard[data-id="${activeId}"]`);
    if (!root) return;

    L.DomEvent.disableClickPropagation(root);
    L.DomEvent.disableScrollPropagation(root);

    const imgEl = root.querySelector(".rdrImg");
    if (imgEl) imgEl.onerror = () => { imgEl.src = WAGON_URL; };

    const closeBtn = root.querySelector('[data-action="close"]');
    if (closeBtn) closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); marker.closePopup(); };

    root.querySelectorAll("[data-pick]").forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = parseInt(btn.getAttribute("data-pick"), 10);
        if (!Number.isFinite(id)) return;
        marker.setPopupContent(groupCardHtml(wagons, groupIds, id));
        setTimeout(() => bindGroupPopup(wagons, groupIds, id, marker), 0);
      };
    });
  }

  // ===== PRELOAD MAP =====
  const preload = new Image();
  preload.onload = () => initMap(preload.width, preload.height);
  preload.onerror = () => alert("–ù–µ –º–æ–∂—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ map.jpg. –ü–µ—Ä–µ–≤—ñ—Ä —Ñ–∞–π–ª map.jpg –ø–æ—Ä—É—á –∑ index.html");
  preload.src = MAP_URL;

  function initMap(MAP_WIDTH, MAP_HEIGHT){
    // zoom –≤–Ω–∏–∑-–ø—Ä–∞–≤–æ—Ä—É—á —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫–∏
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: false,
      zoomAnimation: false,
      markerZoomAnimation: false,
      fadeAnimation: false
    });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const bounds = [[0,0],[MAP_HEIGHT, MAP_WIDTH]];
    L.imageOverlay(MAP_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    const wagons = WAGONS_DATA.map((w, idx) => {
      const out = { ...w };
      if (out.x == null || out.y == null){
        out.x = Math.round(MAP_WIDTH * (0.55 + (idx%5)*0.04));
        out.y = Math.round(MAP_HEIGHT * (0.25 + Math.floor(idx/5)*0.06));
      }
      return out;
    });

    // ===== MARKERS BY GROUPS (–º—ñ—Ç–∫–∏ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ) =====
    const wagonIdToOpener = new Map();      // wagonId -> function open this wagon
    const wagonIdToGroupLabel = new Map();  // wagonId -> label #min-max

    GROUPS.forEach(g => {
      const label = groupLabel(g.ids);

      const icon = L.divIcon({
        className: "",
        html: markerHtml(label),
        iconSize: [44, 44],
        iconAnchor: [0, 0]
      });

      // ‚úÖ draggable: false ‚Äî –ª—é–¥—è–º –Ω–µ –º–æ–∂–Ω–∞ —Ä—É—Ö–∞—Ç–∏
      const marker = L.marker([g.y, g.x], { icon, draggable: false }).addTo(map);

      function openGroup(activeId){
        marker.bindPopup(
          groupCardHtml(wagons, g.ids, activeId),
          { closeButton: false, maxWidth: 600, autoPan: true, keepInView: true }
        ).openPopup();
        setTimeout(() => bindGroupPopup(wagons, g.ids, activeId, marker), 0);
      }

      marker.on("click", () => openGroup(g.ids[0]));

      // –¥–ª—è —Å–∞–π–¥–±–∞—Ä—É ‚Äî –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –ø–æ–≤–æ–∑–∫—É (–Ω–∞–≤—ñ—Ç—å –≤ –≥—Ä—É–ø—ñ)
      g.ids.forEach(id => {
        wagonIdToOpener.set(id, () => {
          map.setView([g.y, g.x], Math.max(map.getZoom(), 0), { animate: true });
          openGroup(id);
        });
        wagonIdToGroupLabel.set(id, label);
      });
    });

    // ===== COORDS TOGGLE (–±–µ–∑ alert) =====
    let coordsEnabled = false;
    const coordsBtn = document.getElementById("coordsBtn");
    const toast = document.getElementById("coordsToast");
    let toastTimer = null;

    function showToast(text){
      toast.textContent = text;
      toast.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = "none"; }, 1200);
    }

    coordsBtn.onclick = () => {
      coordsEnabled = !coordsEnabled;
      coordsBtn.textContent = coordsEnabled ? "üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: –£–≤—ñ–º–∫" : "üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: –í–∏–º–∫";
      if (!coordsEnabled) toast.style.display = "none";
    };

    map.on('click', (e) => {
      if (!coordsEnabled) return;
      showToast(`Y: ${Math.round(e.latlng.lat)}   X: ${Math.round(e.latlng.lng)}`);
    });

    // ===== SIDEBAR =====
    const sidebar = document.getElementById("sidebar");
    const listBtn = document.getElementById("listBtn");
    const sideClose = document.getElementById("sideClose");
    const sideList = document.getElementById("sideList");

    function openSidebar(){ sidebar.classList.add("open"); }
    function closeSidebar(){ sidebar.classList.remove("open"); }

    listBtn.onclick = () => sidebar.classList.contains("open") ? closeSidebar() : openSidebar();
    sideClose.onclick = closeSidebar;

    sideList.innerHTML = wagons
      .slice()
      .sort((a,b) => a.id - b.id)
      .map(w => {
        const group = wagonIdToGroupLabel.get(w.id) || `#${w.id}`;
        return `
          <div class="wagonItem" data-wagon="${w.id}">
            <div class="wagonLeft">
              <div class="wagonTop">#${w.id} ‚Äî ${esc(w.title || "–í–æ–∑–∏–∫")}</div>
              <div class="wagonSub">${esc(w.code || "")} ‚Ä¢ –≥—Ä—É–ø–∞ ${esc(group)}</div>
            </div>
            <div class="wagonPill">${fmtPriceDot(w.price)} $</div>
          </div>
        `;
      }).join("");

    sideList.querySelectorAll("[data-wagon]").forEach(el => {
      el.onclick = () => {
        const id = parseInt(el.getAttribute("data-wagon"), 10);
        const open = wagonIdToOpener.get(id);
        if (open){
          closeSidebar();
          open();
        }
      };
    });

    // ===== RELOAD BUTTON =====
    document.getElementById("reloadBtn").onclick = () => location.reload();
  }
</script>
</body>
</html>
